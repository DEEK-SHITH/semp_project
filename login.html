<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Smart Timetable</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="top">
    <h1>Smart Timetable System</h1>
    <p>Secure Login Portal</p>
  </div>

  <div class="container">
    <div class="login-panel">
      <div class="login-header">
        <h2>Welcome Back</h2>
        <p id="rolePrompt">Sign in to your account</p>
        <div id="roleBadge" class="role-badge" style="display: none;"></div>
      </div>
      
      <form id="loginForm">
        <div class="form-group">
          <label for="email">Email Address *</label>
          <input type="email" id="email" placeholder="Enter your registered email" required>
        </div>
        
        <div class="form-group">
          <label for="password">Password *</label>
          <input type="password" id="password" placeholder="Enter your password" minlength="6" required>
          <div class="password-actions">
            <a href="#" onclick="showForgotPassword()">Forgot Password?</a>
          </div>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="rememberMe">
            Remember me
          </label>
        </div>

        <button type="submit" class="login-btn">
          <span class="btn-text">Sign In</span>
          <span class="btn-loader" style="display: none;">Signing In...</span>
        </button>
      </form>
      
      <div id="login-status" class="status-message"></div>
      
      <!-- Demo Accounts Section -->
      <div class="demo-accounts">
        <h3>üöÄ Demo Accounts - Test the System</h3>
        <div class="demo-buttons">
          <button type="button" class="demo-btn student-demo" onclick="fillDemoCredentials('student')">
            <strong>Student Demo</strong><br>
            Email: student@demo.com | Password: student123
          </button>
          <button type="button" class="demo-btn faculty-demo" onclick="fillDemoCredentials('faculty')">
            <strong>Faculty Demo</strong><br>
            Email: faculty@demo.com | Password: faculty123
          </button>
          <button type="button" class="demo-btn admin-demo" onclick="fillDemoCredentials('admin')">
            <strong>Admin Demo</strong><br>
            Email: admin@demo.com | Password: admin123
          </button>
        </div>
      </div>
      
      <div class="auth-links">
        <p>Don't have an account? <a href="register.html">Create Account</a></p>
        <button type="button" onclick="goToHome()" class="back-btn">‚Üê Back to Home</button>
      </div>

      <!-- Forgot Password Modal -->
      <div id="forgotPasswordModal" class="modal" style="display: none;">
        <div class="modal-content">
          <h3>Reset Password</h3>
          <p>Enter your email address and we'll send you a link to reset your password.</p>
          <input type="email" id="resetEmail" placeholder="Your registered email address" required>
          <div class="modal-actions">
            <button type="button" onclick="sendResetLink()" class="action-btn primary">Send Reset Link</button>
            <button type="button" onclick="hideForgotPassword()" class="back-btn">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { authManager } from './auth.js';

    let currentRole = null;

    // Check if user is already logged in on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Login page loaded');
      
      // Check if user is already authenticated
      if (authManager.isAuthenticated()) {
        console.log('User already authenticated, redirecting...');
        authManager.redirectToDashboard();
        return;
      }

      // Check URL parameters for role
      const urlParams = new URLSearchParams(window.location.search);
      currentRole = urlParams.get('role');
      
      console.log('URL role parameter:', currentRole);
      
      // Update UI based on role
      updateRoleUI(currentRole);
      
      // Set up login form
      setupLoginForm();
    });

    function updateRoleUI(role) {
      const rolePrompt = document.getElementById('rolePrompt');
      const roleBadge = document.getElementById('roleBadge');
      
      if (role) {
        const roleNames = {
          'student': 'Student',
          'faculty': 'Faculty', 
          'admin': 'Administrator'
        };
        
        rolePrompt.textContent = `Sign in as ${roleNames[role]}`;
        roleBadge.textContent = `${roleNames[role]} Portal`;
        roleBadge.style.display = 'inline-block';
        roleBadge.className = `role-badge ${role}-badge`;
      } else {
        rolePrompt.textContent = 'Sign in to your account';
        roleBadge.style.display = 'none';
      }
    }

    function setupLoginForm() {
      const loginForm = document.getElementById('loginForm');
      
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Login form submitted');
        
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const rememberMe = document.getElementById('rememberMe').checked;
        const statusElement = document.getElementById('login-status');
        const loginBtn = document.querySelector('.login-btn');
        const btnText = loginBtn.querySelector('.btn-text');
        const btnLoader = loginBtn.querySelector('.btn-loader');
        
        // Validation
        if (!email || !password) {
          showStatus('Please fill in all required fields', 'error');
          return;
        }

        if (password.length < 6) {
          showStatus('Password must be at least 6 characters', 'error');
          return;
        }

        // Show loading state
        btnText.style.display = 'none';
        btnLoader.style.display = 'inline';
        loginBtn.disabled = true;
        clearStatus();
        
        try {
          const result = await authManager.login(email, password);
          
          if (result.success) {
            showStatus('Login successful! Redirecting...', 'success');
            
            // Store remember me preference
            if (rememberMe) {
              localStorage.setItem('rememberMe', 'true');
            }
            
            console.log('Login successful, redirecting in 1 second...');
            
            // Redirect to appropriate dashboard
            setTimeout(() => {
              authManager.redirectToDashboard();
            }, 1000);
            
          }
        } catch (error) {
          console.error('Login error:', error);
          showStatus(error.message, 'error');
          
          // Reset button state
          btnText.style.display = 'inline';
          btnLoader.style.display = 'none';
          loginBtn.disabled = false;
        }
      });
    }

    function fillDemoCredentials(role) {
      console.log('Filling demo credentials for:', role);
      const credentials = {
        'student': { email: 'student@demo.com', password: 'student123' },
        'faculty': { email: 'faculty@demo.com', password: 'faculty123' },
        'admin': { email: 'admin@demo.com', password: 'admin123' }
      };
      
      const creds = credentials[role];
      document.getElementById('email').value = creds.email;
      document.getElementById('password').value = creds.password;
      
      // Update role in UI
      currentRole = role;
      updateRoleUI(role);
      
      showStatus(`Demo ${role} credentials loaded. Click Sign In to continue.`, 'info');
    }

    function showStatus(message, type) {
      const statusElement = document.getElementById('login-status');
      statusElement.textContent = message;
      statusElement.className = `status-message ${type}`;
      statusElement.style.display = 'block';
      console.log('Status:', message);
    }

    function clearStatus() {
      const statusElement = document.getElementById('login-status');
      statusElement.textContent = '';
      statusElement.className = 'status-message';
      statusElement.style.display = 'none';
    }

    function showForgotPassword() {
      document.getElementById('forgotPasswordModal').style.display = 'flex';
    }

    function hideForgotPassword() {
      document.getElementById('forgotPasswordModal').style.display = 'none';
      document.getElementById('resetEmail').value = '';
    }

    function goToHome() {
      window.location.href = 'index.html';
    }

    async function sendResetLink() {
      const email = document.getElementById('resetEmail').value.trim();
      
      if (!email) {
        alert('Please enter your email address');
        return;
      }

      if (!validateEmail(email)) {
        alert('Please enter a valid email address');
        return;
      }
      
      try {
        await authManager.resetPassword(email);
        alert('Password reset link has been sent to your email!');
        hideForgotPassword();
      } catch (error) {
        alert('Error sending reset link: ' + error.message);
      }
    }

    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('forgotPasswordModal');
      if (event.target === modal) {
        hideForgotPassword();
      }
    }

    // Make functions globally available
    window.fillDemoCredentials = fillDemoCredentials;
    window.showForgotPassword = showForgotPassword;
    window.hideForgotPassword = hideForgotPassword;
    window.sendResetLink = sendResetLink;
    window.goToHome = goToHome;
  </script>
</body>
</html>